
<h3>Activities</h3>
<%= link_to('Add', { :controller => 'activities', :action => 'add' }) %>

<%= link_to('Delete', { :controller => 'activities', :action => 'delete' }, :id => 'delete') %>
<%=
  grid(@activities_grid, show_filters: :when_filtered) do |g|
    g.action_column

    g.column :name => 'ID', :attribute => 'id' do |activity|
      activity.id
    end

    g.column :name => 'Number', :attribute => 'number' do |activity|
      activity.number
    end

    g.column :name => 'Type', :attribute => 'name', :model => 'ActivityType' do |activity|
      activity.type.name if activity.type
    end

    g.column :name => 'Date', :attribute => 'date' do |activity|
      activity.date
    end

    g.column :name => 'From Organization', :attribute => 'name', :model => 'Organization', :table_alias => 'from_organization' do |activity|
      activity.from_organization.name if activity.from_organization
    end

    g.column :name => 'To Organization', :attribute => 'name', :model => 'Organization', :table_alias => 'to_organization' do |activity|
      activity.to_organization.name if activity.to_organization
    end

    g.column :name => 'Owner', :attribute => 'email', :model => 'User' do |activity|
      activity.owner.email if activity.owner
    end

    g.column :name => 'Total', :attribute => 'total' do |activity|
      activity.total
    end

    #g.column :name => 'Note', :attribute => 'note' do |activity|
      #activity.note
    #end

    #g.column :name => 'Tag', :attribute => 'tag' do |activity|
      #activity.tag
    #end

    #g.column :name => 'Created at', :attribute => 'created_at' do |activity|
      #activity.created_at.to_s(:short)
    #end

    #g.column :name => 'Updated at', :attribute => 'updated_at' do |activity|
      #activity.updated_at.to_s(:short)
    #end

    g.column do |activity|
      a = link_to('Edit', { :controller => 'activities', :action => 'edit', :id => activity.id })

      unless @activity
        a += ' '
        a += link_to('Children', { :controller => 'activities', :action => 'show', :parent_id => activity.id })
      end

      a += ' '
      a += link_to('Delete', { :controller => 'activities', :action => 'delete', :id => activity.id }, :data => { :confirm => 'Are you sure?' })

      a
    end
  end
%>
<%
  if @activity
%>
  <%= link_to('Go to parent', { :controller => 'activities', :action => 'show', :parent_id => @activity.parent_id }) %>
<%
  end
%>
<script type="text/javascript">
  $(document).ready( function() {
    $('#delete').click( function() {
      if (!confirm('Are you sure?')) {
        return false;
      }

      var selected = $('input[type=checkbox][name^=grid]:checked');
      var ids = [];

      for(var i = 0; i < selected.length; i++) {
        ids[i] = selected[i].value
      }

      if (ids.length < 1) {
        alert('Please select at least one activity');

        return false;
      }

      $.ajax({
        type: 'GET',
        url: '/activities/delete',
        data: { id: ids },
        dataType : 'json',
        async: false,
        success: function(e) {
          if (e == true) {
            location.reload();
          }
        }
      });

      return false;
    });
  });
</script>
